# Разработка драйверов

Драйвера находятся по пути [src/drivers/](../../src/drivers/)

У каждого драйвера должна быть своя директория

Сборка драйвера - это индивидуальный процесс поэтому необходимо локально создать Makefile и собрать драйвер в объектный файл по пути `output/drivers/`

### Функция Init
— это функция, запускаемая менеджером драйверов при регистрации драйвера. Менеджер драйверов передаёт адрес структуры устройства, драйвер должен определить: сможет ли он обслуживать данное устройство. Если может, то функция возвращает `1`, если же драйвер не подходит, то функция должна вернуть `0`.
Сигнатура функции init:
```
int init(struct dev_info*);
```

> Название не может совпадать с другими функциями ядра

> Функция init должна быть определена в header файле, подключаемый в `src/drivers/driver_list.c`

### Дополнительные функции
— это функции драйверов, которые должны быть реализованы в зависимости от [спецификации ядра](function_specification.md). 
> Пример: драйвер клавиатуры должен в обязательном порядке реализовать функцию для получения адреса буффера клавиатуры

Адреса этих функций должны быть в массиве, который затем используется для [регистрации драйвера](#registration). Порядок определяется [спецификацией](function_specification.md)

Первый аргумент каждой дополнительной функции - это адрес на структуру устройства

> Название массива должно быть уникальным

> Массив с адресами функций должен быть определён в header файле, подключаемый в `src/drivers/driver_list.c`

## Registration

Чтобы ядро увидело ваш драйвер, необходимо зарегестрировать его перед компиляцией

Для этого в файле [src/drivers/driver_list.c](../../src/drivers/driver_list.c) необходимо подключить заголовочный файл вашего драйвера в секции `Includes drivers`, а также в секции `Driver list` добавить в макрос DRIVER_LIST определение в формате:
```
X(НАЗВАНИЕ_ДРАЙВЕРА,   "ФАЙЛ_ДРАЙВЕРА", КЛАСС_УСТРОЙСТВ, ПОДКЛАСС_УСТРОЙСТВ, ФУНКЦИЯ_ИНИЦИАЛИЗАЦИИ, МАССИВ_ФУНКЦИЙ)
```

- `НАЗВАНИЕ_ДРАЙВЕРА` - это название которое будет отображаться в системе

- `ФАЙЛ_ДРАЙВЕРА` - не обязательная часть, можно указать что угодно, но обязательно в кавычках

- `КЛАСС_УСТРОЙСТВ` - класс устройств для которых предназначен драйвер

- `ПОДКЛАСС_УСТРОЙСТВ` - подкласс устройств для которых предназначен драйвер

- `ФУНКЦИЯ_ИНИЦИАЛИЗАЦИИ` - адрес функции инициализации. Можно просто указать название функции

- `МАССИВ_ФУНКЦИЙ` - адрес на массив дополнительных функций


## Kernel API

Есть возможность использовать API функции ядра. Для этого необходимо подключить заголовочный файл [src/api/kernel_functions.h](../../src/api/kernel_functions.h)

Доступные функции расписаны в [документации API](../api/internal_api.md)

